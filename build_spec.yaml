version: "0.1"
component: "build"
timeoutInSeconds: "1000"
shell: "bash"

steps:
  - type: "Command"
    name: "Check and Install Java 11"
    command: |
      echo "Checking current Java version..."
      CURRENT_JAVA_VERSION=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}' | cut -d'.' -f1-2)
      echo "Current Java version is $CURRENT_JAVA_VERSION"

      if [ "$CURRENT_JAVA_VERSION" != "11" ]; then
        echo "Installing Java 11..."
        yum install -y java-11-openjdk-devel
        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
        export PATH=$JAVA_HOME/bin:$PATH
      else
        echo "Java 11 is already installed."
      fi
      java -version

  - type: "Command"
    name: "Check and Install Maven"
    command: |
      echo "Checking Maven installation..."
      if ! type "mvn" > /dev/null; then
        echo "Maven is not installed. Installing Maven..."
        yum install -y maven
      else
        echo "Maven is already installed."
      fi
      mvn -version

  - type: "Command"
    name: "Build Application"
    command: |
      echo "Starting build process with Maven..."
      mvn -B clean install
      echo "Build process complete."

  - type: "Command"
    name: "Check Docker Installation"
    command: |
      echo "Checking Docker version..."
      docker --version

  - type: "Command"
    name: "Build and Push Docker Images to Docker Hub"
    command: |
      echo "Logging into Docker Hub..."
      echo $DOCKERHUB_TOKEN | docker login --username $DOCKERHUB_USERNAME --password-stdin
      
      for service in feed-service Kafka-consumer-service follow-service post-service; do
        # Convert service name to lowercase for Docker tag
        service_lower=$(echo $service | tr '[:upper:]' '[:lower:]')
      
        # Build and push the Docker image
        docker build -t moukthikavuyyuru/$service_lower:latest ./$service
        docker push moukthikavuyyuru/$service_lower:latest
      done
      
