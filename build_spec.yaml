version: "0.1"
component: build
timeoutInSeconds: "1000"
shell: bash
env:
  vaultVariables:
    OCI_REGISTRY_USERNAME: moukthikareddy.vuyyuru@sjsu.edu
    OCI_REGISTRY_TOKEN: ocid1.credential.oc1..aaaaaaaad4rjea3gwy3yfwsduey4vm7i4isgic5yt5rvw5nuf5vb5t7asqeq

steps:
  - type: Command
    name: Check and Install Java 11
    command: >
      echo "Checking current Java version..."
      CURRENT_JAVA_VERSION=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}' | cut -d'.' -f1-2)
      echo "Current Java version is $CURRENT_JAVA_VERSION"
      if [ "$CURRENT_JAVA_VERSION" != "11" ]; then
        echo "Installing Java 11..."
        yum install -y java-11-openjdk-devel || exit 1
        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
        export PATH=$JAVA_HOME/bin:$PATH
      else
        echo "Java 11 is already installed."
      fi
      java -version || exit 1

  - type: Command
    name: Check and Install Maven
    command: |
      echo "Checking Maven installation..."
      if ! type "mvn" > /dev/null; then
        echo "Maven is not installed. Installing Maven..."
        yum install -y maven || exit 1
      else
        echo "Maven is already installed."
      fi
      mvn -version || exit 1

  - type: Command
    name: Build Application
    command: |
      echo "Starting build process with Maven..."
      export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
      export PATH=$JAVA_HOME/bin:$PATH
      mvn -version
      mvn clean install -DskipTests || exit 1
      echo "Build process complete."

  - type: Command
    name: Build and Push Docker Images
    command: |
      echo "Logging into OCI Container Registry..."
      echo $OCI_REGISTRY_TOKEN | docker login us-sanjose-1.ocir.io --username $OCI_REGISTRY_USERNAME --password-stdin || exit 1
      UNIQUE_TAG=$(echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7)
      for service in feed follow post consumer; do
        echo "Building Docker image for $service..."
        docker build -t us-sanjose-1.ocir.io/moukthikareddy/docker-images/$service:$UNIQUE_TAG ./$service || exit 1
        echo "Pushing Docker image for $service to OCI Container Registry..."
        docker push us-sanjose-1.ocir.io/moukthikareddy/docker-images/$service:$UNIQUE_TAG || exit 1
      done

outputArtifacts:
  - name: feed-service-image
    type: DOCKER_IMAGE
    location: us-sanjose-1.ocir.io/moukthikareddy/docker-images/feed:$UNIQUE_TAG
  - name: follow-service-image
    type: DOCKER_IMAGE
    location: us-sanjose-1.ocir.io/moukthikareddy/docker-images/follow:$UNIQUE_TAG
  - name: post-service-image
    type: DOCKER_IMAGE
    location: us-sanjose-1.ocir.io/moukthikareddy/docker-images/post:$UNIQUE_TAG
  - name: kafka-consumer-service-image
    type: DOCKER_IMAGE
    location: us-sanjose-1.ocir.io/moukthikareddy/docker-images/consumer:$UNIQUE_TAG
  - name: feed-service-manifest
    type: BINARY
    location: ${OCI_PRIMARY_SOURCE_DIR}/k8s/feed/feed.yaml
  - name: follow-service-manifest
    type: BINARY
    location: ${OCI_PRIMARY_SOURCE_DIR}/k8s/follow/follow.yaml
  - name: post-service-manifest
    type: BINARY
    location: ${OCI_PRIMARY_SOURCE_DIR}/k8s/post/post.yaml
  - name: kafka-consumer-service-manifest
    type: BINARY
    location: ${OCI_PRIMARY_SOURCE_DIR}/k8s/consumer/kafka-consumer.yaml
