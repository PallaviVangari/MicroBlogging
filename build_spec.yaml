---
version: "0.1"
component: build
timeoutInSeconds: "1000"
shell: bash
env:
  vaultVariables:
    DOCKERHUB_USERNAME: ocid1.vaultsecret.oc1.us-sanjose-1.amaaaaaaeftofsqa2suhlrletprxa5ngp32eescov3uii452wb2hngsiogca
    DOCKERHUB_TOKEN: ocid1.vaultsecret.oc1.us-sanjose-1.amaaaaaaeftofsqavhu4eqic4njf6ze6yqut5qqjvvjuad6wcwkwatuwbcyq
steps:
  - type: Command
    name: Check and Install Java 11
    command: >
      echo "Checking current Java version..."

      CURRENT_JAVA_VERSION=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}' | cut -d'.' -f1-2)

      echo "Current Java version is $CURRENT_JAVA_VERSION"

      if [ "$CURRENT_JAVA_VERSION" != "11" ]; then
        echo "Installing Java 11..."
        yum install -y java-11-openjdk-devel || exit 1
        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
        export PATH=$JAVA_HOME/bin:$PATH
      else
        echo "Java 11 is already installed."
      fi

      java -version || exit 1
  - type: Command
    name: Check and Install Maven
    command: |
      echo "Checking Maven installation..."
      if ! type "mvn" > /dev/null; then
        echo "Maven is not installed. Installing Maven..."
        yum install -y maven || exit 1
      else
        echo "Maven is already installed."
      fi
      mvn -version || exit 1
  - type: Command
    name: Build Application
    command: |
      echo "Starting build process with Maven..."
      export JAVA_HOME=/usr/lib/jvm/java-11-openjdk
      export PATH=$JAVA_HOME/bin:$PATH
      mvn -version
      mvn clean install -DskipTests || exit 1
      echo "Build process complete."
  - type: Command
    name: Build and Push Docker Images to Docker Hub
    command: >
      echo "Logging into Docker Hub..."

      echo $DOCKERHUB_TOKEN | docker login --username $DOCKERHUB_USERNAME --password-stdin || exit 1


      for service in feed-service Kafka-consumer-service follow-service post-service; do
        # Convert service name to lowercase for Docker tag
        service_lower=$(echo $service | tr '[:upper:]' '[:lower:]')

        # Build and push the Docker image
        echo "Building Docker image for $service..."
        docker build -t moukthikavuyyuru/$service_lower:test ./$service || exit 1
        echo "Pushing Docker image for $service to Docker Hub..."
        docker push moukthikavuyyuru/$service_lower:test || exit 1
      done
  - type: Command
    name: Define unique image tag
    timeoutInSeconds: 40
    command: |
      export BUILDRUN_HASH=`echo ${OCI_BUILD_RUN_ID} | rev | cut -c 1-7`
      echo "BUILDRUN_HASH: " $BUILDRUN_HASH
  - type: Command
    timeoutInSeconds: 1200
    name: Build container image
    command: |
      cd ${OCI_PRIMARY_SOURCE_DIR}
      docker build --pull --rm -t feed_service ./feed-service || exit 1
outputArtifacts:
  - name: oke_app_base
    type: DOCKER_IMAGE
    location: oke_app_base:latest
  - name: oke_deploy_manifest
    type: BINARY
    location: ${OCI_PRIMARY_SOURCE_DIR}/feed.yaml
